<!doctype html>
<html>
  <head>
    <title>Tarea 3</title>
    <style>
      html, body { height: 100%; width: 100%; margin: 0; }
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to socket
    var socket = io('wss://integracion-tarea-3.herokuapp.com', { path: '/flights'} );
    
    // Listen to events
    socket.on('AIRPORTS', function(data){ addAirportsToMap(data) });
    socket.on('FLIGHTS', function(data){ addFlightsToMap(data) });

    // Emit flights and airports events
    socket.emit('FLIGHTS');
    socket.emit('AIRPORTS');
  </script>

  <body>
    <div id="map"></div>
    <script>
      var map;
      var flights = {};
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: -33.4569400, lng: -70.6482700}
        });
      }

      function addAirportsToMap(data) {
        var lines = []
        for (code in data) {
          var position = data[code]['airport_position'];
          var marker = new google.maps.Marker({
            position: { lat: position[0], lng: position[1] },
            map: map
          });
          lines = lines.concat({ lat: position[0], lng: position[1] });
        }

        // Add origin-destination lines on map
        var flightPath = new google.maps.Polyline({
          path: lines,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 0.5,
          strokeWeight: 2
        });
        flightPath.setMap(map);
      }

      function addFlightsToMap(data) {
        for (flight in data) {
          var marker = new google.maps.Marker({
            map: map
          });
          flights[data[flight]['code']] = marker;
        }

        // Listen to position for update
        socket.on('POSITION', function(data){ updateFlights(data) });
      }

      function updateFlights(data) {
        position = data['position'];
        var newPosition = new google.maps.LatLng(position[0], position[1]);
        flights[data['code']].setPosition(newPosition);
      }
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMN1ajMU5q2miCveUT4jIcQLs0BwkpsVU&callback=initMap">
    </script>
  </body>
</html>
